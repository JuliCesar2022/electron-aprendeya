<style>
    /* My Learning Specific Styles */
    .navbar {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding: 15px 0;
        position: sticky;
        top: 0;
        z-index: 1000;
    }

    .nav-container {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        padding: 0 20px;
        gap: 20px;
    }

    .nav-left {
        display: flex;
        justify-content: flex-start;
    }

    .nav-center {
        display: flex;
        justify-content: center;
    }

    .nav-right {
        display: flex;
        justify-content: flex-end;
    }

    .back-btn-nav {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 10px 15px;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
        backdrop-filter: blur(10px);
    }

    .back-btn-nav:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .logo {
        font-size: 1.8rem;
        font-weight: bold;
        color: white;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
        color: white;
    }

    .user-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: bold;
        color: white;
    }

    .user-details h3 {
        margin: 0;
        font-size: 1.1rem;
    }

    .user-details p {
        margin: 0;
        opacity: 0.8;
        font-size: 0.9rem;
    }

    .logout-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }

    .logout-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .main-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .welcome-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 40px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        text-align: center;
    }

    .welcome-title {
        font-size: 2.5rem;
        margin-bottom: 10px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .welcome-subtitle {
        font-size: 1.2rem;
        color: #666;
        margin-bottom: 30px;
    }

    .search-container {
        max-width: 600px;
        margin: 0 auto;
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 18px 60px 18px 20px;
        border: 2px solid #e1e8ed;
        border-radius: 50px;
        font-size: 1.1rem;
        outline: none;
        transition: all 0.3s ease;
        background: white;
    }

    .search-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .search-btn {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        background: linear-gradient(45deg, #667eea, #764ba2);
        border: none;
        border-radius: 50px;
        padding: 12px 20px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .search-btn:hover {
        transform: translateY(-50%) scale(1.05);
    }

    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        backdrop-filter: blur(10px);
    }

    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-label {
        color: #666;
        font-size: 0.9rem;
    }

    .dashboard-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .card-title {
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: #333;
    }

    .courses-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .course-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .course-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .course-image {
        height: 150px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
    }

    .course-content {
        padding: 20px;
    }

    .course-title {
        font-weight: 600;
        margin-bottom: 10px;
        color: #333;
    }

    .course-instructor {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 10px;
    }

    .course-progress {
        background: #f0f0f0;
        border-radius: 10px;
        height: 8px;
        overflow: hidden;
        margin-bottom: 10px;
    }

    .course-progress-bar {
        height: 100%;
        background: linear-gradient(45deg, #4ecdc4, #44bd87);
        transition: width 0.3s ease;
    }

    .quick-actions {
        position: fixed;
        bottom: 30px;
        right: 30px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .quick-action-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .quick-action-btn:hover {
        transform: scale(1.1);
    }

    .btn-notes {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
    }

    .btn-screenshot {
        background: linear-gradient(45deg, #4ecdc4, #44bd87);
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .dashboard-card, .welcome-section {
        animation: fadeInUp 0.6s ease-out forwards;
    }

    @media (max-width: 768px) {
        .nav-container {
            padding: 0 15px;
            gap: 10px;
            grid-template-columns: auto 1fr auto;
        }
        
        .logo {
            font-size: 1.4rem;
        }
        
        .back-btn-nav {
            padding: 8px 12px;
            font-size: 0.8rem;
        }
        
        .user-info {
            gap: 10px;
        }
        
        .user-details {
            display: none;
        }
        
        .main-container {
            padding: 20px 15px;
        }
        
        .welcome-section {
            padding: 25px;
        }
        
        .welcome-title {
            font-size: 2rem;
        }
        
        .courses-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }
    }
</style>

<nav class="navbar">
    <div class="nav-container">
        <div class="nav-left">
            <button class="back-btn-nav" id="back-btn-nav">‚¨ÖÔ∏è Volver</button>
        </div>
        <div class="nav-center">
            <div class="logo">
                <img src="assets/icon.png" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; vertical-align: middle;">
                Udemigo
            </div>
        </div>
        <div class="nav-right">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-details">
                    <h3 id="userName">Usuario</h3>
                    <p id="userEmail">email@ejemplo.com</p>
                </div>
                <button class="logout-btn" id="logout-btn">üö™ Salir</button>
            </div>
        </div>
    </div>
</nav>

<div class="main-container">
    <div class="welcome-section">
        <h1 class="welcome-title">Mi Aprendizaje</h1>
        <p class="welcome-subtitle">Aqu√≠ puedes ver todos tus cursos y tu progreso.</p>
        
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Busca en tus cursos..." id="searchInput">
            <button class="search-btn" id="search-my-courses-btn">üîç</button>
        </div>
    </div>

    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-number" style="color: #667eea;">12</div>
            <div class="stat-label">Cursos Completados</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" style="color: #4ecdc4;">3</div>
            <div class="stat-label">En Progreso</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" style="color: #ff6b6b;">45h</div>
            <div class="stat-label">Tiempo Total</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" style="color: #764ba2;">8</div>
            <div class="stat-label">Certificados</div>
        </div>
    </div>

    <div class="dashboard-card" style="margin-top: 30px;">
        <h3 class="card-title">üî• Mis Cursos</h3>
        <div class="courses-grid" id="myCoursesList">
            <!-- Los cursos se cargar√°n din√°micamente -->
        </div>
    </div>
</div>

<div class="quick-actions">
    <button class="quick-action-btn btn-notes" id="open-notes-btn" title="Notas R√°pidas">üìù</button>
    <button class="quick-action-btn btn-screenshot" id="take-screenshot-btn" title="Captura de Pantalla">üì∏</button>
</div>

<script src="auth.js"></script>
<script>
    // My Learning Page Scripts - Solo se ejecutan cuando esta p√°gina est√° activa
    
    let myLearningInitialized = false;
    let allMyCourses = [];

    // Funci√≥n de inicializaci√≥n que solo se ejecuta una vez
    function initializeMyLearningPage() {
        if (myLearningInitialized) return;
        
        
        loadUserData();
        loadMyCourses();

        // Event listeners
        document.getElementById('logout-btn')?.addEventListener('click', logout);
        document.getElementById('search-my-courses-btn')?.addEventListener('click', searchMyCourses);
        document.getElementById('searchInput')?.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                searchMyCourses();
            }
        });
        document.getElementById('open-notes-btn')?.addEventListener('click', openNotes);
        document.getElementById('take-screenshot-btn')?.addEventListener('click', takeScreenshot);
        document.getElementById('back-btn-nav')?.addEventListener('click', () => {
            if (window.electronAPI) {
                window.electronAPI.send('go-to-udemy-webview');
            } else {
                window.location.href = 'https://www.udemy.com/';
            }
        });

        myLearningInitialized = true;
    }

    function loadUserData() {
        if (window.authManager && window.authManager.isAuthenticated()) {
            const userInfo = window.authManager.getUserInfo();
            
            if (userInfo.fullname) {
                const userNameEl = document.getElementById('userName');
                if (userNameEl) userNameEl.textContent = userInfo.fullname;
                
                const initial = userInfo.fullname.charAt(0).toUpperCase();
                const userAvatarEl = document.getElementById('userAvatar');
                if (userAvatarEl) userAvatarEl.textContent = initial;
            }
            
            if (userInfo.email) {
                const userEmailEl = document.getElementById('userEmail');
                if (userEmailEl) userEmailEl.textContent = userInfo.email;
            }
        }
    }

    async function loadMyCourses() {
        const container = document.getElementById('myCoursesList');
        if (!container) return;
        
        container.innerHTML = '<p style="color:white;">Cargando cursos...</p>';

        try {
            const token = window.authManager?.getToken();
            if (!token) throw new Error("Token no disponible");

            const response = await fetch('https://aprendeya-backend.forif.co/api/v1/user-courses', {
                headers: {
                    Authorization: `Bearer ${token}`
                }
            });

            if (!response.ok) throw new Error('Error al cargar cursos');

            const result = await response.json();
            allMyCourses = result.data || result;

            if (!Array.isArray(allMyCourses) || allMyCourses.length === 0) {
                container.innerHTML = '<p style="color:white;">No tienes cursos registrados a√∫n.</p>';
                return;
            }

            renderCourses(allMyCourses);

        } catch (error) {
            console.error('Error cargando cursos:', error);
            container.innerHTML = '<p style="color:red;">Error al cargar tus cursos.</p>';
        }
    }

    function renderCourses(coursesToRender) {
        const container = document.getElementById('myCoursesList');
        if (!container) return;
        
        if (!Array.isArray(coursesToRender) || coursesToRender.length === 0) {
            container.innerHTML = '<p style="color:white;">No se encontraron cursos que coincidan con tu b√∫squeda.</p>';
            return;
        }

        container.innerHTML = coursesToRender.map(item => {
            const course = item.course;
            return `
                <div class="course-card" onclick="openCourse('https://www.udemy.com/course/${course.urlCourseUdemy}/learn/')">
                    <div class="course-image" style="background: url('${course.urlImage}') center/cover no-repeat;"></div>
                    <div class="course-content">
                        <div class="course-title">${course.name}</div>
                        <div class="course-instructor">Curso de Udemy</div>
                        <div class="course-progress">
                            <div class="course-progress-bar" style="width: 0%"></div>
                        </div>
                        <small>Progreso desconocido</small>
                    </div>
                </div>
            `;
        }).join('');
    }

    function searchMyCourses() {
        const searchInput = document.getElementById('searchInput');
        if (!searchInput) return;
        
        const query = searchInput.value.toLowerCase();
        let filteredCourses = [];

        if (query) {
            filteredCourses = allMyCourses.filter(item => {
                const course = item.course;
                return course.name.toLowerCase().includes(query);
            });
        } else {
            filteredCourses = allMyCourses;
        }
        renderCourses(filteredCourses);
    }

    async function openCourse(url) {
        if (window.electronAPI) {
            try {
                showLoadingMessage('Cargando curso...');
                
                const success = await window.electronAPI.invoke('chrome-launch-course', url);
                
                hideLoadingMessage();
                
                if (success) {
                    showNotification('¬°Curso abierto en Brave con tu sesi√≥n!', 'success');
                } else {
                    showNotification('Error abriendo el curso', 'error');
                    window.electronAPI.send('webview-navigate', url);
                }
            } catch (error) {
                hideLoadingMessage();
                showNotification('Error abriendo el curso', 'error');
                window.electronAPI.send('webview-navigate', url);
            }
        } else {
            window.open(url, '_blank');
        }
    }

    function showLoadingMessage(message) {
        const existingLoader = document.getElementById('courseLoader');
        if (existingLoader) existingLoader.remove();
        
        const loader = document.createElement('div');
        loader.id = 'courseLoader';
        loader.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            z-index: 10000;
            font-size: 16px;
            text-align: center;
            backdrop-filter: blur(5px);
        `;
        loader.innerHTML = `
            <div style="margin-bottom: 10px;">üéì</div>
            <div>${message}</div>
            <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">Esto puede tomar unos segundos...</div>
        `;
        document.body.appendChild(loader);
    }

    function hideLoadingMessage() {
        const loader = document.getElementById('courseLoader');
        if (loader) loader.remove();
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 10001;
            max-width: 400px;
            background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 4000);
    }

    function openNotes() {
        if (window.electronAPI) {
            window.electronAPI.showNotes();
        } else {
            window.open('notes.html', '_blank', 'width=400,height=300');
        }
    }

    function takeScreenshot() {
        if (window.electronAPI) {
            window.electronAPI.takeScreenshot();
        } else {
            alert('üì∏ Funci√≥n de captura disponible solo en la aplicaci√≥n Electron');
        }
    }

    function logout() {
        const confirmed = confirm('¬øEst√°s seguro que deseas cerrar sesi√≥n?');
        if (!confirmed) return;

        try {
            if (window.authManager) {
                window.authManager.logout();
            }
            
            if (window.electronAPI) {
                window.electronAPI.invoke('clear-cookies');
                window.electronAPI.send('go-to-home');
            } else {
                window.location.href = 'pages/index/index.html';
            }
            
        } catch (error) {
            console.error('Error durante logout:', error);
        }
    }

    // Funci√≥n de limpieza para cuando se cambia de p√°gina
    function cleanupMyLearningPage() {
        
        // Remover event listeners espec√≠ficos si es necesario
        const elements = [
            'logout-btn', 'search-my-courses-btn', 'searchInput', 
            'open-notes-btn', 'take-screenshot-btn', 'back-btn-nav'
        ];
        
        elements.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                // Clone y replace para remover todos los event listeners
                const newEl = el.cloneNode(true);
                el.parentNode.replaceChild(newEl, el);
            }
        });
        
        // Reset variables
        allMyCourses = [];
        myLearningInitialized = false;
        
    }

    // Registrar funciones de inicializaci√≥n y limpieza en el navigation manager
    if (window.appNavigationManager) {
        window.appNavigationManager.registerPageCleanup('my-learning', cleanupMyLearningPage);
    }

    // Auto-inicializar cuando la p√°gina se carga
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeMyLearningPage);
    } else {
        initializeMyLearningPage();
    }

    // Exportar funciones para uso externo si es necesario
    window.MyLearningPage = {
        initialize: initializeMyLearningPage,
        cleanup: cleanupMyLearningPage,
        loadMyCourses: loadMyCourses,
        searchMyCourses: searchMyCourses
    };
</script>